<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>RestBioSamples - Generic Frontend Demo</title>
</head>

<script type="text/javascript" src="https://cdn.lacunasoftware.com/libs/restpki/lacuna-restpki-widget-1.3.1.min.js"
	integrity="sha256-PziIkD0H3D/3KAcwE/u7u8MTbd6k62IlI9mmqzkc9r0="
	crossorigin="anonymous"></script>

<body>
	<h1>RestPkiWidget - Bio Session Demo</h1>
	<script>

		function displayResponse(data) {
			document.getElementById('responseArea').value = JSON.stringify(data, null, 2);
		}

		async function livenessTest() {
			let widget = RestPkiWidget.init();

			fetch("/sample-api/sessions/liveness", {
				method: "POST",
			}).then(async (response) => {
				let sessionInfo = await response.json();
				let result = await widget.performBioSession(sessionInfo.sessionUrl);
				fetch("/sample-api/sessions/liveness/completion", {
					method: "POST",
					body: JSON.stringify({
						ticket: result.completeTicket
					}),
					headers: {
						"Content-Type": "application/json"
					}
				}).then(async (response) => {
					let completionResult = await response.json();
					displayResponse(completionResult);
					console.log(completionResult);
				});
			}).catch(error => {
				console.error('Error:', error);
				alert('Liveness error!');
			});
		}

		async function enrollmentTest() {
			let widget = RestPkiWidget.init();

			let subjectId = document.getElementById('subjectId')?.value;

			if (!subjectId || subjectId.trim() === '') {
				alert('Please enter the Subject Identifier for enrollment!');
				return;
			}

			fetch("/sample-api/sessions/enrollment", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({
					subjectIdentifier: subjectId
				})
			}).then(async (response) => {
				if (!response.ok) {
					alert('Error: already registered!');
					return;
				}
				let sessionInfo = await response.json();
				let result = await widget.performBioSession(sessionInfo.sessionUrl);
				fetch("/sample-api/sessions/enrollment/completion", {
					method: "POST",
					body: JSON.stringify({
						ticket: result.completeTicket
					}),
					headers: {
						"Content-Type": "application/json"
					}
				}).then(async (response) => {
					let completionResult = await response.json();
					displayResponse(completionResult);
					console.log(completionResult);
				});
			}).catch(error => {
				console.error('Error:', error);
				alert('Enrollment error!');
			});
		}

		async function authenticationTest() {
			let widget = RestPkiWidget.init();

			let subjectId = document.getElementById('subjectId')?.value;

			if (!subjectId || subjectId.trim() === '') {
				alert('Please enter the Subject Identifier!');
				return;
			}

			fetch("/sample-api/sessions/authentication", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({
					identifier: subjectId
				})
			}).then(async (response) => {
				if (!response.ok) {
					alert('Error: Subject not found or not registered!');
					return;
				}
				let sessionInfo = await response.json();
				let result = await widget.performBioSession(sessionInfo.sessionUrl);
				fetch("/sample-api/sessions/authentication/completion", {
					method: "POST",
					body: JSON.stringify({
						ticket: result.completeTicket
					}),
					headers: {
						"Content-Type": "application/json"
					}
				}).then(async (response) => {
					let completionResult = await response.json();
					displayResponse(completionResult);
					console.log(completionResult);
				});
			}).catch(error => {
				console.error('Error:', error);
				alert('Authentication error!');
			});
		}

	</script>
	<input type="text" id="subjectId" placeholder="Subject Identifier">
	<br><br>
	<a onclick="livenessTest()" href="#">Liveness Test</a><br><br>
	<a onclick="enrollmentTest()" href="#">Enrollment Test</a><br><br>
	<a onclick="authenticationTest()" href="#">Authentication Test</a>
	<br><br>
	<h3>Result:</h3>
	<textarea id="responseArea" style="width: 30%; height: 250px;"></textarea>
</body>

</html>